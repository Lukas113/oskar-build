name: Build Binary Packages Linux

on: [ push ]

jobs:
  build_and_upload:
    runs-on: ubuntu-latest
    container: ubuntu
    steps:
      - name: Install build tools
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y git build-essential cmake python3 casacore-dev
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Package
        run: |
          chmod +x package.sh
          bash -e package.sh
      - name: Archive binaries
        uses: actions/upload-artifact@v2
        with:
          name: OSKAR Binaries ${{ runner.os }}
          path: |
            oskar-binaries-${{ runner.os }}-x86_64.tar.gz
  test_user_space_binaries:
    needs: build_and_upload
    runs-on: ubuntu-latest
    container: ubuntu
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v2
        with:
          name: OSKAR Binaries ${{ runner.os }}
      - name: Install essential components
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y git wget unzip python3 python3-pip casacore-dev
      - name: Install and test
        shell: bash
        run: |
          tar -xvzf oskar-binaries-${{ runner.os }}-x86_64.tar.gz
          cd package-${{ runner.os }}
          chmod +x test.sh
          chmod +x install.sh
          bash -e install.sh
          bash -e test.sh
      - name: Save test result
        uses: actions/upload-artifact@v2
        with:
          name: Test Results ${{ runner.os }}
          path: |
            package-${{ runner.os }}/result.vis
            package-${{ runner.os }}/result.ms
  package_deb:
    needs: build_and_upload
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Download binaries
        uses: actions/download-artifact@v2
        with:
          name: OSKAR Binaries ${{ runner.os }}
      - name: Unpack binaries
        run: |
          tar -xvzf oskar-binaries-${{ runner.os }}-x86_64.tar.gz
          mkdir oskar
          cp -r package-${{ runner.os }}/oskar/* oskar/
      - name: Package binaries as deb
        run: |
          chmod +x package-debian.sh
          bash -e package-debian.sh
      - name: Upload deb to artefacts
        uses: actions/upload-artifact@v2
        with:
          name: Debian_Package
          path: |
            *.deb
  test_deb_package:
    needs: package_deb
    runs-on: ubuntu-latest
    container: ubuntu
    steps:
      - name: Install dependencies
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y python3 python3-pip wget unzip git casacore-dev
      - name: Download debian package
        uses: actions/download-artifact@v2
        with:
          name: Debian_Package
      - name: Install debian package
        run: |
          dpkg -i *.deb
          ls /usr/local/lib
          ls /usr/local/include/oskar
          ls /usr/local/bin
      - name: Install Python Interface
        run: |
          pip3 install numpy
          pip3 install --user 'git+https://github.com/i4Ds/OSKAR.git@master#egg=oskarpy&subdirectory=python'
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Test Python interface
        run: |
          python3 test.py
      - name: Save deb test result
        uses: actions/upload-artifact@v2
        with:
          name: Test Results Deb ${{ runner.os }}
          path: |
            result.vis
            result.ms
